<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æ–‡æ‰“å­—å¤§å¸« v3.5 - ç·¨è¼¯å„ªåŒ–ç‰ˆ</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e74c3c;
            --bg: #fdfaf4; 
            --box: #ffffff;
        }
        body { font-family: "Helvetica Neue", "Helvetica", "Hiragino Sans", "Hiragino Kaku Gothic ProN", "Arial", "Yu Gothic", "Meiryo", sans-serif; background-color: var(--bg); color: var(--primary); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 850px; background: var(--box); padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        h1 { text-align: center; font-size: 28px; margin-bottom: 30px; letter-spacing: 2px; }
        
        .stats-bar { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #eee; }
        .stat-label { font-size: 14px; color: #7f8c8d; margin-bottom: 5px; display: block; }
        .stat-value { font-size: 24px; font-weight: bold; color: var(--primary); }

        #displayArea { 
            font-size: 28px; line-height: 3.5; height: 350px; overflow: hidden; position: relative;
            padding: 20px; border: 2px solid #eee; border-radius: 12px; background: #fff; margin-bottom: 25px;
            white-space: pre-wrap; word-break: break-all; scroll-behavior: smooth;
        }
        .focus-line { position: absolute; top: 28%; left: 0; right: 0; height: 60px; background: rgba(44, 62, 80, 0.03); pointer-events: none; }

        .char-correct { color: #dcdde1; }
        .char-wrong { background: #fab1a0; color: #d63031; border-radius: 4px; }
        .char-current { background: #2c3e50; color: #fff; border-radius: 4px; padding: 0 4px; }

        #inputField { 
            width: 100%; height: 70px; font-size: 22px; padding: 15px; border: 3px solid #2c3e50;
            border-radius: 10px; box-sizing: border-box; outline: none; transition: 0.3s;
        }
        #inputField:focus { box-shadow: 0 0 15px rgba(44, 62, 80, 0.2); }

        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.3s; }
        .btn-main { background: #2c3e50; color: white; width: 100%; }
        .btn-main:hover { opacity: 0.9; }
        .btn-sub { background: #ecf0f1; color: #7f8c8d; margin-top: 10px; }

        textarea#sourceText { width: 100%; height: 180px; padding: 15px; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; }
        .setup-group { margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div id="setupArea">
        <h1>ğŸ‡¯ğŸ‡µ æ—¥æ–‡æ‰“å­—ç·´ç¿’å¤§å¸«</h1>
        <div class="setup-group">
            <label>1. è²¼ä¸Šç·´ç¿’æ–‡ç« ï¼š</label><br><br>
            <textarea id="sourceText">ã‚ã„ã†ãˆãŠã€€ã‹ããã‘ã“ã€€ã•ã—ã™ã›ãã€€ãŸã¡ã¤ã¦ã¨ã€€ãªã«ã¬ã­ã®ã€€ã¯ã²ãµã¸ã»ã€€ã¾ã¿ã‚€ã‚ã‚‚ã€€ã‚„ã‚†ã‚ˆã€€ã‚‰ã‚Šã‚‹ã‚Œã‚ã€€ã‚ã‚’ã‚“</textarea>
        </div>
        <div class="setup-group">
            <label>2. è¨­å®šåˆ†é˜æ•¸ï¼š</label>
            <input type="number" id="timeSetting" value="1" min="0.5" step="0.5" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
        </div>
        <button class="btn btn-main" onclick="initGame()">é–‹å§‹è¨“ç·´</button>
    </div>

    <div id="practiceArea" style="display:none;">
        <div class="stats-bar">
            <div class="stat-card"><span class="stat-label">å‰©é¤˜æ™‚é–“</span><span id="timer" class="stat-value">-</span></div>
            <div class="stat-card"><span class="stat-label">å­— / åˆ†é˜</span><span id="cpm" class="stat-value">0</span></div>
            <div class="stat-card"><span class="stat-label">æ­£ç¢ºç‡</span><span id="accuracy" class="stat-value">100%</span></div>
        </div>
        <div id="displayArea">
            <div class="focus-line"></div>
            <div id="textContainer"></div>
        </div>
        <input type="text" id="inputField" placeholder="é–‹å§‹è¼¸å…¥..." oninput="processInput()" disabled autocomplete="off">
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-sub" style="flex: 1;" onclick="resetGame()">é‡æ–°é–‹å§‹</button>
            <button class="btn btn-sub" style="flex: 1;" onclick="backToSetup()">ä¿®æ”¹è¨­å®š / æ›æ–‡ç« </button>
        </div>
    </div>
</div>

<script>
    let originalText = "", timeLeft = 60, timerInterval, isPlaying = false, startTime = null;
    const inputField = document.getElementById('inputField');

    function initGame() {
        originalText = document.getElementById('sourceText').value.trim();
        if (!originalText) return alert("è«‹è¼¸å…¥æ–‡ç« ");
        
        // å–å¾—åˆ†é˜ä¸¦è¨­å®šç§’æ•¸
        timeLeft = Math.floor(parseFloat(document.getElementById('timeSetting').value) * 60);
        
        // é¡¯ç¤ºç·´ç¿’å€ï¼Œéš±è—è¨­å®šå€
        document.getElementById('setupArea').style.display = 'none';
        document.getElementById('practiceArea').style.display = 'block';
        
        // é‡ç½®ç‹€æ…‹
        clearInterval(timerInterval);
        startTime = null;
        inputField.value = "";
        document.getElementById('cpm').innerText = "0";
        document.getElementById('accuracy').innerText = "100%";
        
        renderText();
        document.getElementById('timer').innerText = timeLeft;
        inputField.disabled = false;
        inputField.focus();
        isPlaying = true;
    }

    function renderText() {
        const container = document.getElementById('textContainer');
        container.innerHTML = "";
        originalText.split('').forEach((char, i) => {
            const span = document.createElement('span');
            span.innerText = char;
            if (i === 0) span.className = 'char-current';
            container.appendChild(span);
        });
        document.getElementById('displayArea').scrollTop = 0;
    }

    function processInput() {
        if (!isPlaying) return;
        if (startTime === null) {
            startTime = new Date();
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').innerText = timeLeft;
                if (timeLeft <= 0) endGame();
            }, 1000);
        }

        const inputChars = inputField.value.split('');
        const spans = document.getElementById('textContainer').querySelectorAll('span');
        let correct = 0;

        spans.forEach((span, i) => {
            span.className = '';
            if (inputChars[i] == null) {
                if (i === inputChars.length) {
                    span.className = 'char-current';
                    // è‡ªå‹•æ²å‹•
                    const container = document.getElementById('displayArea');
                    const scrollTarget = span.offsetTop - (container.offsetHeight * 0.28);
                    container.scrollTop = scrollTarget;
                }
            } else if (inputChars[i] === span.innerText) {
                span.className = 'char-correct';
                correct++;
            } else {
                span.className = 'char-wrong';
            }
        });

        const elapsed = (new Date() - startTime) / 60000;
        document.getElementById('cpm').innerText = Math.floor(inputChars.length / (elapsed || 0.001));
        document.getElementById('accuracy').innerText = Math.floor((correct / (inputChars.length || 1)) * 100) + "%";
        
        if (inputChars.length >= originalText.length) endGame();
    }

    function endGame() {
        clearInterval(timerInterval);
        isPlaying = false;
        inputField.disabled = true;
        alert(`ç·´ç¿’çµæŸï¼\né€Ÿåº¦ï¼š${document.getElementById('cpm').innerText} å­—/åˆ†\næ­£ç¢ºç‡ï¼š${document.getElementById('accuracy').innerText}`);
    }

    function resetGame() {
        initGame();
    }

    // æ–°å¢åŠŸèƒ½ï¼šå›åˆ°è¨­å®šå€ï¼Œä¸”ä¿ç•™å…§å®¹
    function backToSetup() {
        clearInterval(timerInterval);
        isPlaying = false;
        document.getElementById('setupArea').style.display = 'block';
        document.getElementById('practiceArea').style.display = 'none';
    }
</script>
</body>
</html>
