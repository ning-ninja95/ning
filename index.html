<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æ–‡æ‰“å­—ç·´ç¿’ - éŠæˆ²éŸ³æ•ˆç‰ˆv6.7</title>
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6485376162723745"
     crossorigin="anonymous"></script>

    <style>
        /* --- æ¨£å¼è¨­å®š --- */
        :root { --bg: #f0f2f5; --box: #ffffff; --primary: #34495e; --text: #2c3e50; --accent: #e74c3c; }
        [data-theme="matcha"] { --bg: #e6e6d1; --box: #fbfbf6; --primary: #556b2f; --text: #3e4a2e; }
        [data-theme="sakura"] { --bg: #f2e6e6; --box: #fffafa; --primary: #b35a6d; --text: #5d3a43; }
        [data-theme="blue"] { --bg: #dbe4eb; --box: #f5f9fc; --primary: #375a7f; --text: #20354b; }

        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: var(--bg); margin: 0; padding: 0; transition: 0.3s; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .wrapper { display: flex; justify-content: center; width: 100%; max-width: 1400px; padding: 40px 10px; box-sizing: border-box; }
        
        .ad-sidebar { 
            width: 180px; display: flex; flex-direction: column; padding-top: 40px; flex-shrink: 0; gap: 20px;
        }

        .container { flex: 1; max-width: 800px; background: var(--box); padding: 40px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.05); margin: 0 30px; position: relative; }
        
        /* å³å´é¢æ¿æ¨£å¼ */
        .right-panel {
            background: rgba(255,255,255,0.5); padding: 15px; border-radius: 12px;
            backdrop-filter: blur(5px); box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .panel-title { font-size: 0.9em; font-weight: bold; color: var(--primary); margin-bottom: 10px; display: block; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 5px; }

        .color-btn { width: 24px; height: 24px; border-radius: 50%; border: 2px solid rgba(0,0,0,0.1); cursor: pointer; display: inline-block; margin-right: 5px; }
        .btn-default { background-color: #34495e; } .btn-matcha { background-color: #556b2f; }
        .btn-sakura { background-color: #b35a6d; } .btn-blue { background-color: #375a7f; }

        /* éŸ³æ•ˆé¸é … */
        .sound-option { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.9em; cursor: pointer; padding: 8px; border-radius: 6px; transition: 0.2s; color: var(--text); }
        .sound-option:hover { background: rgba(0,0,0,0.05); }
        .sound-option.active { background: var(--primary); color: white; }
        
        .volume-control { margin-top: 10px; }
        .volume-control input { width: 100%; cursor: pointer; }
        .volume-label { font-size: 0.8em; color: var(--text); display: flex; justify-content: space-between; }

        textarea, input[type="number"] { width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 16px; margin-bottom: 20px; outline: none; box-sizing: border-box; }
        
        /* é¡¯ç¤ºå€åŸŸ */
        #displayArea { 
            font-size: 28px; line-height: 2.5; height: 250px; overflow: hidden; padding: 40px 20px; 
            border: none; background: linear-gradient(to bottom, transparent 0%, rgba(0,0,0,0.02) 100%); 
            border-radius: 10px; margin-bottom: 60px; white-space: pre-wrap; word-break: break-all; 
            position: relative; text-align: left; 
        }
        #displayArea::before { content: ""; position: absolute; top: 40%; left: 0; right: 0; height: 2px; background: rgba(0,0,0,0.03); pointer-events: none; z-index: 0; }
        #textContainer { position: relative; z-index: 1; padding-bottom: 250px; display: block; }

        .char-current { background: rgba(85, 107, 47, 0.2); color: var(--text); border-bottom: 3px solid var(--primary); border-radius: 2px; font-weight: bold; }
        .char-correct { color: #d0d0d0; transition: color 0.2s; } 
        .char-wrong { background: var(--accent); color: white; border-radius: 4px; }
        .char-return::after { content: 'â†µ'; font-size: 0.7em; color: #ccc; margin-left: 2px; vertical-align: middle; }
        .char-current.char-return::after { color: var(--primary); }

        #inputField { 
            width: 100%; height: 60px; font-size: 24px; padding: 10px 15px; 
            border: 2px solid var(--primary); border-radius: 8px; box-sizing: border-box; 
            outline: none; resize: none; overflow: hidden; font-family: inherit;
            transition: box-shadow 0.1s;
        }
        /* è¼¸å…¥æ™‚çš„å¾®ç™¼å…‰ç‰¹æ•ˆ */
        #inputField:focus { box-shadow: 0 0 0 4px rgba(85, 107, 47, 0.1); }

        .btn-group { display: flex; gap: 15px; margin-top: 25px; }
        .btn { padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%; background: var(--primary); color: white; transition: 0.2s; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }

        /* â˜… Combo é€£æ“Šç‰¹æ•ˆæ¨£å¼ â˜… */
        #comboDisplay {
            position: absolute;
            bottom: 20px;
            right: 40px;
            font-size: 1.5em;
            font-weight: 900;
            color: var(--primary);
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
        }
        #comboDisplay.show { opacity: 1; transform: scale(1); }
        #comboDisplay.pop { transform: scale(1.3); } /* æ‰“å­—æ™‚çš„è·³å‹• */

        @media (max-width: 1100px) { .ad-sidebar { display: none; } .container { margin: 0; } }
    </style>
</head>
<body>

<div class="wrapper">
    <div class="ad-sidebar"></div>

    <div class="container">
        <div id="comboDisplay">COMBO x 0</div>

        <div id="setupArea">
            <h2 style="text-align:center; color:var(--primary);">ğŸ‡¯ğŸ‡µ æ—¥æ–‡æ‰“å­—ç·´ç¿’</h2>
            <textarea id="sourceText" placeholder="åœ¨æ­¤è²¼ä¸Šç·´ç¿’æ–‡ç« ...">ã‚ã„ã†ãˆãŠ ã‹ããã‘ã“
ã•ã—ã™ã›ã ãŸã¡ã¤ã¦ã¨
ãªã«ã¬ã­ã®</textarea>
            <label style="font-weight:bold; color:var(--primary);">è¨­å®šåˆ†é˜æ•¸ï¼š</label>
            <input type="number" id="timeSetting" value="1" min="0.5" step="0.5">
            <button class="btn" onclick="startGame()">é–‹å§‹ç·´ç¿’</button>
        </div>

        <div id="practiceArea" style="display:none;">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-weight:bold; color:var(--primary); font-size: 1.1em;">
                <span>â³ <span id="timerDisplay">60</span> ç§’</span>
                <span>ğŸš€ é€Ÿåº¦ï¼š<span id="speedDisplay">0</span> å­—/åˆ†</span>
                <span>ğŸ¯ æ­£ç¢ºç‡ï¼š<span id="accDisplay">100%</span></span>
            </div>
            
            <div id="displayArea"><div id="textContainer"></div></div>
            <textarea id="inputField" placeholder="é»æ­¤é–‹å§‹è¼¸å…¥..." oninput="processInput()" autocomplete="off"></textarea>
            
            <div class="btn-group">
                <button class="btn" onclick="retryGame()">ğŸ”„ é‡æ–°é–‹å§‹</button>
                <button class="btn" onclick="backToSetup()">âš™ï¸ ä¿®æ”¹è¨­å®š</button>
            </div>
        </div>
    </div>

    <div class="ad-sidebar">
        <div class="right-panel">
            <span class="panel-title">ğŸ¨ ä¸»é¡Œè‰²å½©</span>
            <div style="margin-top:10px;">
                <button class="color-btn btn-default" onclick="changeTheme('default')" title="æ¥µç°¡æ·±ç°"></button>
                <button class="color-btn btn-matcha" onclick="changeTheme('matcha')" title="ç¦ªæ„æŠ¹èŒ¶"></button>
                <button class="color-btn btn-sakura" onclick="changeTheme('sakura')" title="ä¹¾ç‡¥ç«ç‘°"></button>
                <button class="color-btn btn-blue" onclick="changeTheme('blue')" title="è«è˜­è¿ªè—"></button>
            </div>
        </div>

        <div class="right-panel">
            <span class="panel-title">ğŸ”Š éŸ³æ•ˆé¸æ“‡</span>
            <div class="sound-option active" onclick="setSound('mechanical', this)">
                <span>ğŸ”µ é’è»¸ (Crisp)</span>
            </div>
            <div class="sound-option" onclick="setSound('gaming', this)">
                <span>ğŸ® éŠæˆ²æ©Ÿ (Gaming)</span>
            </div>
            <div class="sound-option" onclick="setSound('bubble', this)">
                <span>ğŸ«§ æ°£æ³¡éŸ³ (Soft)</span>
            </div>
            <div class="sound-option" onclick="setSound('mute', this)">
                <span>ğŸ”‡ éœéŸ³</span>
            </div>

            <div class="volume-control">
                <div class="volume-label">
                    <span>éŸ³é‡</span>
                    <span id="volValue">50%</span>
                </div>
                <input type="range" min="0" max="100" value="50" oninput="changeVolume(this.value)">
            </div>
        </div>
    </div>
</div>

<script>
    let originalText = "", timeLeft = 60, totalTime = 60, timerInterval = null, isPlaying = false, hasStarted = false;
    let comboCount = 0;

    // --- â˜… éŸ³æ•ˆå¼•æ“ â˜… ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx = new AudioContext();
    let masterGain = audioCtx.createGain();
    masterGain.connect(audioCtx.destination);
    masterGain.gain.value = 0.5;
    let currentSoundType = 'mechanical';

    // ç”ŸæˆçœŸå¯¦æ„Ÿçš„é»æ“Šè²
    function playRealClick(type) {
        if (currentSoundType === 'mute') return;
        if (audioCtx.state === 'suspended') audioCtx.resume();
        
        const t = audioCtx.currentTime;
        const gain = audioCtx.createGain();
        gain.connect(masterGain);

        if (type === 'mechanical') {
            // é’è»¸ï¼šé«˜é »å™ªéŸ³çˆ†ç™¼
            const bufferSize = audioCtx.sampleRate * 0.05; 
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1; 
            }
            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;
            
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'highpass';
            filter.frequency.value = 1000;
            
            noise.connect(filter);
            filter.connect(gain);
            
            gain.gain.setValueAtTime(0.8, t);
            gain.gain.exponentialRampToValueAtTime(0.01, t + 0.05); 
            
            noise.start(t);

        } else if (type === 'gaming') {
            // â˜… éŠæˆ²æ©ŸéŸ³æ•ˆï¼š8-bit å¾©å¤æ–¹æ³¢ (Square Wave) â˜…
            const osc = audioCtx.createOscillator();
            osc.type = 'square'; // æ–¹æ³¢æœ€æœ‰å¾©å¤éŠæˆ²æ„Ÿ
            osc.frequency.setValueAtTime(150, t);
            osc.frequency.exponentialRampToValueAtTime(40, t + 0.08); // å¿«é€Ÿä¸‹é™çš„é »ç‡
            
            gain.gain.setValueAtTime(0.6, t);
            gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
            
            osc.connect(gain);
            osc.start(t);
            osc.stop(t + 0.1);
            
        } else if (type === 'bubble') {
            // æ°£æ³¡éŸ³
            const osc = audioCtx.createOscillator();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(400, t);
            osc.frequency.linearRampToValueAtTime(800, t + 0.1);
            gain.gain.setValueAtTime(0.3, t);
            gain.gain.exponentialRampToValueAtTime(0.01, t + 0.15);
            osc.connect(gain);
            osc.start(t);
            osc.stop(t + 0.15);
        }
    }

    // â˜… éŒ¯èª¤éŸ³æ•ˆ (æ‚¨èªªè¦ç•™è‘—çš„é€™å€‹) â˜…
    function playErrorSound() {
        if (currentSoundType === 'mute') return;
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const t = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(masterGain);
        
        // é‹¸é½’æ³¢ï¼Œè½èµ·ä¾†åƒã€Œæ»‹~ã€
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(150, t);
        osc.frequency.linearRampToValueAtTime(100, t + 0.2);
        gain.gain.setValueAtTime(0.3, t);
        gain.gain.exponentialRampToValueAtTime(0.01, t + 0.2);
        osc.start(t);
        osc.stop(t + 0.2);
    }

    function setSound(type, element) {
        currentSoundType = type;
        document.querySelectorAll('.sound-option').forEach(el => el.classList.remove('active'));
        if(element) element.classList.add('active');
        if(type !== 'mute') playRealClick(type);
    }

    function changeVolume(val) {
        masterGain.gain.value = val / 100;
        document.getElementById('volValue').innerText = val + "%";
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }
    // --- â˜… éŸ³æ•ˆå¼•æ“çµæŸ â˜… ---

    function changeTheme(theme) { document.documentElement.setAttribute('data-theme', theme === 'default' ? '' : theme); }
    
    function startGame() {
        originalText = document.getElementById('sourceText').value.trim(); 
        if(!originalText) return alert("è«‹è²¼ä¸Šå…§å®¹");
        let min = parseFloat(document.getElementById('timeSetting').value) || 1;
        totalTime = Math.floor(min * 60);
        document.getElementById('setupArea').style.display = 'none';
        document.getElementById('practiceArea').style.display = 'block';
        if (audioCtx.state === 'suspended') audioCtx.resume();
        resetGameLogic(totalTime);
    }
    
    function retryGame() { startGame(); }
    
    function resetGameLogic(seconds) {
        timeLeft = seconds; renderText();
        document.getElementById('timerDisplay').innerText = timeLeft;
        document.getElementById('accDisplay').innerText = "100%";
        document.getElementById('speedDisplay').innerText = "0";
        comboCount = 0; updateComboDisplay();
        const input = document.getElementById('inputField'); input.value = ""; input.disabled = false; input.focus();
        hasStarted = false; isPlaying = true; if(timerInterval) clearInterval(timerInterval);
    }
    
    function renderText() {
        const container = document.getElementById('textContainer'); container.innerHTML = "";
        originalText.split('').forEach((char, i) => {
            const span = document.createElement('span'); 
            span.innerText = char;
            if (char === '\n') span.className = 'char-return';
            if (i === 0) span.classList.add('char-current');
            container.appendChild(span);
        });
        document.getElementById('displayArea').scrollTop = 0;
    }
    
    function updateComboDisplay() {
        const comboEl = document.getElementById('comboDisplay');
        if (comboCount > 5) {
            comboEl.innerText = "COMBO x " + comboCount;
            comboEl.classList.add('show');
            comboEl.classList.remove('pop');
            void comboEl.offsetWidth; 
            comboEl.classList.add('pop');
            
            if (comboCount > 20) comboEl.style.color = "#e74c3c"; 
            else if (comboCount > 10) comboEl.style.color = "#e67e22"; 
            else comboEl.style.color = "var(--primary)";
        } else {
            comboEl.classList.remove('show');
        }
    }

    function processInput() {
        if(!isPlaying) return;
        if(!hasStarted) { hasStarted = true; startTimer(); }
        
        const inputVal = document.getElementById('inputField').value;
        const spans = document.getElementById('textContainer').querySelectorAll('span');
        const displayArea = document.getElementById('displayArea'); 
        let correctCount = 0;
        let currentSpan = null;
        let isError = false;

        spans.forEach((span, i) => {
            span.className = (originalText[i] === '\n') ? 'char-return' : '';
            if (inputVal[i] == null) {
                if (i === inputVal.length) {
                    span.classList.add('char-current');
                    currentSpan = span; 
                }
            } else {
                if(inputVal[i] === originalText[i]) { 
                    span.classList.add('char-correct'); 
                    correctCount++; 
                } else { 
                    span.classList.add('char-wrong');
                    if (i === inputVal.length - 1) isError = true;
                }
            }
        });

        // åˆ¤æ–·æ˜¯å¦éœ€è¦æ’­æ”¾éŸ³æ•ˆ
        if (inputVal.length > 0) {
             if (inputVal.length > (document.getElementById('inputField').getAttribute('data-prev-len') || 0)) {
                 if (isError) {
                     playErrorSound(); // â˜… ä¿ç•™éŒ¯èª¤éŸ³æ•ˆ
                     comboCount = 0; 
                 } else {
                     playRealClick(currentSoundType); // æ’­æ”¾é¸æ“‡çš„éŸ³æ•ˆ
                     comboCount++; 
                 }
                 updateComboDisplay();
             }
        }
        document.getElementById('inputField').setAttribute('data-prev-len', inputVal.length);

        if (currentSpan) {
            let topPos = currentSpan.offsetTop;
            let displayHeight = displayArea.clientHeight;
            displayArea.scrollTop = topPos - (displayHeight * 0.35); 
        }

        if(inputVal.length > 0) document.getElementById('accDisplay').innerText = Math.floor((correctCount / inputVal.length) * 100) + "%";
        updateSpeed(correctCount);
        if (inputVal.length >= originalText.length) endGame("ğŸ‰ ç·´ç¿’å®Œæˆï¼");
    }
    
    function updateSpeed(correctCount) {
        let timeElapsed = totalTime - timeLeft;
        if (timeElapsed <= 0) timeElapsed = 1;
        let cpm = Math.floor((correctCount / timeElapsed) * 60);
        document.getElementById('speedDisplay').innerText = cpm;
    }
    
    function startTimer() {
        timerInterval = setInterval(() => {
            timeLeft--; document.getElementById('timerDisplay').innerText = timeLeft;
            const inputVal = document.getElementById('inputField').value;
            let correctCount = 0;
            for(let i=0; i<inputVal.length; i++) { 
                if(inputVal[i] === originalText[i]) correctCount++; 
            }
            updateSpeed(correctCount);
            if(timeLeft <= 0) endGame("â° æ™‚é–“åˆ°ï¼");
        }, 1000);
    }
    
    function endGame(msg) { isPlaying = false; clearInterval(timerInterval); document.getElementById('inputField').disabled = true; setTimeout(() => alert(msg), 100); }
    
    function backToSetup() { isPlaying = false; clearInterval(timerInterval); document.getElementById('practiceArea').style.display = 'none'; document.getElementById('setupArea').style.display = 'block'; }
</script>
</body>
</html>
